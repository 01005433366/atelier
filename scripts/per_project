#!python
# Copyright 2013-2016 by Luc Saffre.
# License: BSD, see LICENSE for more details.
"""USAGE : per_project cmd1 [cmd2 ...]

Execute `cmd1 [cmd2 ...]` in the root directory of each project,
stopping upon the first error.

Examples::

  $ per_project ls
  $ per_project git st
  $ per_project inv test 
  $ per_project inv ci

The list of projects is configured in your
:xfile:`~/.atelier/config.py` file.

.. command:: pp

We also suggest to define a short alias for this script in your
:xfile:`~/.bash_aliases`::

    alias pp='per_project'

"""
from __future__ import print_function
import os
import sys
import subprocess

from atelier.projects import load_projects
from argh import dispatch_command, arg, CommandError

@dispatch_command
@arg('cmd', help="The command to run on every project.")
@arg('-s', '--start',
     help='Start from that project, skip those before.')
@arg('-u', '--until',
     help='Only until that project, skip those after.')
def main(start=None, until=None, *cmd):
    """Execute `cmd1 [cmd2 ...]` in the root directory of each project,
stopping upon the first error.

The projects are looped in the order defined in your
`~/.atelier/config.py` file.

Examples::

  $ per_project inv test 
  $ per_project -s noi inv test
  $ per_project git st
  $ per_project inv ci

    """
    if len(cmd) == 0:
        raise CommandError("You must specify a command!")
        # print(__doc__)
        # return -1

    skipping = start is not None
    for prj in load_projects():
        if start and prj.nickname == start:
            skipping = False
        if skipping:
            continue
        if until and prj.nickname == until:
            skipping = True
        print("==== %s ====" % prj.nickname)
        #~ p = os.path.join(atelier.PROJECTS_HOME,prj)
        #~ os.chdir(p)
        #~ print(prj.root_dir)
        os.chdir(prj.root_dir)
        #~ args = ["fab"]
        #~ args += commands
        rv = subprocess.call(cmd, cwd=prj.root_dir)
        if rv:
            print("%s in project %s ended with error %s" % (
                ' '.join(commands), prj.nickname, rv))
            return rv
    return 0
        
if __name__ == '__main__':
    sys.exit(main())
    
